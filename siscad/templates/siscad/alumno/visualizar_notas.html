<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Notas - Sistema Académico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-estadistica {
            transition: transform 0.2s;
        }
        .card-estadistica:hover {
            transform: translateY(-5px);
        }
        .badge-aprobado { background-color: #28a745; }
        .badge-desaprobado { background-color: #dc3545; }
        .badge-en-proceso { background-color: #ffc107; color: #000; }
        .progress { height: 20px; }
        .table-notas th { background-color: #f8f9fa; }
        .estadistica-numero { font-size: 2rem; font-weight: bold; }
        .progreso-global { background: linear-gradient(90deg, #e9ecef 0%, #e9ecef 100%); }
        .nota-vacia { color: #6c757d; font-style: italic; }
        .btn-descargar { transition: all 0.3s; }
        .btn-descargar:hover { transform: scale(1.05); }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3">
                            <i class="bi bi-journal-text"></i> Mis Notas Académicas
                        </h1>
                        <p class="text-muted mb-0">Bienvenido a tu portal académico</p>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-1">{{ alumno.nombre }}</h5>
                        <small class="text-muted">DNI: {{ alumno.dni }} | Semestre {{ semestre_actual }}</small>
                        <br>
                        <form method="post" class="mt-2">
                            {% csrf_token %}
                            <button type="submit" name="descargar_excel" class="btn btn-success btn-sm btn-descargar">
                                <i class="bi bi-file-earmark-excel"></i> Descargar Libreta
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progreso General -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Progreso General</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6>Avance de Evaluación General</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar 
                                        {% if estadisticas.progreso_general < 50 %}bg-warning
                                        {% elif estadisticas.progreso_general < 80 %}bg-info
                                        {% else %}bg-success{% endif %}" 
                                        role="progressbar" 
                                        style="width: {{ estadisticas.progreso_general }}%">
                                        {{ estadisticas.progreso_general }}%
                                    </div>
                                </div>
                                <small class="text-muted">
                                    {{ estadisticas.total_notas_registradas }} de {{ estadisticas.total_notas_esperadas }} notas registradas en total
                                </small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="border rounded p-3">
                                    <div class="estadistica-numero text-primary">{{ estadisticas.progreso_general }}%</div>
                                    <small class="text-muted">Progreso Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Generales -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estadísticas Generales</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="card card-estadistica border-success">
                                    <div class="card-body">
                                        <div class="estadistica-numero text-success">{{ estadisticas.promedio_general }}</div>
                                        <small class="text-muted">Promedio General</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card card-estadistica border-info">
                                    <div class="card-body">
                                        <div class="estadistica-numero text-info">{{ estadisticas.total_cursos }}</div>
                                        <small class="text-muted">Total Cursos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card card-estadistica border-success">
                                    <div class="card-body">
                                        <div class="estadistica-numero text-success">{{ estadisticas.cursos_aprobados }}</div>
                                        <small class="text-muted">Cursos Aprobados</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card card-estadistica border-warning">
                                    <div class="card-body">
                                        <div class="estadistica-numero text-warning">{{ estadisticas.cursos_en_proceso }}</div>
                                        <small class="text-muted">En Proceso</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estadísticas adicionales -->
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="card card-estadistica border-secondary">
                                    <div class="card-body">
                                        <div class="estadistica-numero text-secondary">{{ estadisticas.mejor_nota }}</div>
                                        <small class="text-muted">Mejor Nota</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card card-estadistica border-secondary">
                                    <div class="card-body">
                                        <div class="estadistica-numero text-secondary">{{ estadisticas.peor_nota }}</div>
                                        <small class="text-muted">Peor Nota</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card card-estadistica border-info">
                                    <div class="card-body">
                                        <div class="estadistica-numero text-info">{{ estadisticas.cursos_con_sustitutorio }}</div>
                                        <small class="text-muted">Con Sustitutorio</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráficos -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Distribución de Cursos</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="chartEstadoCursos" width="400" height="200"></canvas>
                                        <div class="text-center mt-2">
                                            <small class="text-muted">
                                                Aprobados: {{ estadisticas.porcentaje_aprobados }}% | 
                                                En proceso: {{ estadisticas.porcentaje_en_proceso }}% | 
                                                Desaprobados: {{ estadisticas.porcentaje_desaprobados }}%
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Rendimiento por Curso</h6>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="chartRendimiento" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalle por Curso -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-check"></i> Detalle por Curso</h5>
                        <span class="badge bg-light text-dark">
                            {{ notas_por_curso|length }} cursos encontrados
                        </span>
                    </div>
                    <div class="card-body">
                        {% if notas_por_curso %}
                            {% for curso_data in notas_por_curso %}
                            <div class="card mb-4 border-{% if curso_data.estado == 'aprobado' %}success{% elif curso_data.estado == 'desaprobado' %}danger{% else %}warning{% endif %}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">
                                            <i class="bi bi-book"></i> {{ curso_data.nombre_curso }} 
                                            <small class="text-muted">({{ curso_data.codigo_curso }}) - Turno {{ curso_data.turno }}</small>
                                        </h6>
                                    </div>
                                    <div>
                                        {% if curso_data.promedio_final %}
                                            <span class="badge {% if curso_data.estado == 'aprobado' %}badge-aprobado{% elif curso_data.estado == 'desaprobado' %}badge-desaprobado{% else %}badge-en-proceso{% endif %}">
                                                {{ curso_data.estado|title }} - {{ curso_data.promedio_final }}
                                            </span>
                                        {% else %}
                                            <span class="badge badge-en-proceso">En Proceso</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Barra de Progreso del Curso -->
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small>
                                                <i class="bi bi-clock"></i> Progreso de Evaluación
                                                {% if curso_data.total_notas_registradas == curso_data.total_notas_esperadas %}
                                                    <i class="bi bi-check-circle text-success ms-1"></i>
                                                {% endif %}
                                            </small>
                                            <small>{{ curso_data.progreso }}%</small>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar 
                                                {% if curso_data.progreso < 50 %}bg-warning
                                                {% elif curso_data.progreso < 80 %}bg-info
                                                {% else %}bg-success{% endif %}" 
                                                role="progressbar" 
                                                style="width: {{ curso_data.progreso }}%">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            {{ curso_data.total_notas_registradas }} de {{ curso_data.total_notas_esperadas }} notas registradas
                                        </small>
                                    </div>

                                    <!-- Notas del Curso -->
                                    <div class="row">
                                        <!-- Notas Parciales -->
                                        {% if curso_data.configuracion_curso.tiene_parciales %}
                                        <div class="col-md-6">
                                            <h6><i class="bi bi-file-text"></i> Notas Parciales</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered table-hover">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Parcial</th>
                                                            <th>Nota</th>
                                                            <th>Peso</th>
                                                            <th>Estado</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for parcial in curso_data.datos_parciales %}
                                                        <tr>
                                                            <td>Parcial {{ parcial.periodo }}</td>
                                                            <td>
                                                                {% if parcial.tiene_nota %}
                                                                    <strong>{{ parcial.nota }}</strong>
                                                                {% else %}
                                                                    <span class="nota-vacia">No evaluado</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ parcial.peso }}%</td>
                                                            <td>
                                                                {% if parcial.tiene_nota %}
                                                                    <i class="bi bi-check-circle text-success"></i>
                                                                {% else %}
                                                                    <i class="bi bi-clock text-warning"></i>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Notas Continuas -->
                                        {% if curso_data.configuracion_curso.tiene_continua %}
                                        <div class="col-md-6">
                                            <h6><i class="bi bi-check-square"></i> Notas Continuas</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered table-hover">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Continua</th>
                                                            <th>Nota</th>
                                                            <th>Peso</th>
                                                            <th>Estado</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for continua in curso_data.datos_continuas %}
                                                        <tr>
                                                            <td>Continua {{ continua.periodo }}</td>
                                                            <td>
                                                                {% if continua.tiene_nota %}
                                                                    <strong>{{ continua.nota }}</strong>
                                                                {% else %}
                                                                    <span class="nota-vacia">No evaluado</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ continua.peso }}%</td>
                                                            <td>
                                                                {% if continua.tiene_nota %}
                                                                    <i class="bi bi-check-circle text-success"></i>
                                                                {% else %}
                                                                    <i class="bi bi-clock text-warning"></i>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- Sustitutorio -->
                                    {% if curso_data.tiene_sustitutorio %}
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="alert alert-info">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-arrow-repeat display-6 me-3"></i>
                                                    <div>
                                                        <h6 class="mb-1">Sustitutorio Aplicado</h6>
                                                        <p class="mb-0">Nota de Sustitutorio: <strong>{{ curso_data.nota_sustitutorio }}</strong></p>
                                                        <small class="text-muted">Esta nota reemplaza la más baja entre Parcial 1 y Parcial 2</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Resumen Final -->
                                    {% if curso_data.promedio_final %}
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="alert {% if curso_data.estado == 'aprobado' %}alert-success{% else %}alert-danger{% endif %}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">
                                                            <i class="bi bi-award"></i> Nota Final: {{ curso_data.promedio_final }}
                                                        </h6>
                                                        <p class="mb-0">Estado: <strong>{{ curso_data.estado|title }}</strong></p>
                                                        {% if curso_data.estado == 'aprobado' %}
                                                            <small class="mb-0">¡Felicidades! Has aprobado este curso.</small>
                                                        {% else %}
                                                            <small class="mb-0">Necesitas mejorar tu rendimiento en este curso.</small>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-end">
                                                        {% if curso_data.estado == 'aprobado' %}
                                                            <i class="bi bi-trophy-fill display-4 text-success"></i>
                                                        {% else %}
                                                            <i class="bi bi-exclamation-triangle-fill display-4 text-danger"></i>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="alert alert-warning">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-clock-history display-6 me-3"></i>
                                                    <div>
                                                        <h6 class="mb-1">Curso en Proceso</h6>
                                                        <p class="mb-0">Aún faltan notas por registrar para calcular la nota final.</p>
                                                        <small class="mb-0">Progreso actual: {{ curso_data.progreso }}% completado</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-inbox display-1 text-muted"></i>
                                <h4 class="text-muted mt-3">No tienes cursos matriculados</h4>
                                <p class="text-muted">No se encontraron cursos para mostrar las notas.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Informativo -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            Sistema Académico - Tus notas se actualizan automáticamente. 
                            Para cualquier discrepancia, contacta con tu coordinador académico.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gráfico de distribución de cursos
        const ctxEstado = document.getElementById('chartEstadoCursos').getContext('2d');
        new Chart(ctxEstado, {
            type: 'doughnut',
            data: {
                labels: ['Aprobados', 'En Proceso', 'Desaprobados'],
                datasets: [{
                    data: [
                        {{ estadisticas.cursos_aprobados }},
                        {{ estadisticas.cursos_en_proceso }},
                        {{ estadisticas.cursos_desaprobados }}
                    ],
                    backgroundColor: [
                        '#28a745',
                        '#ffc107', 
                        '#dc3545'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label;
                                const value = context.raw;
                                const total = {{ estadisticas.total_cursos }};
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Gráfico de rendimiento
        const ctxRendimiento = document.getElementById('chartRendimiento').getContext('2d');
        const cursos = [{% for curso in notas_por_curso %}'{{ curso.nombre_curso|slice:":12" }}...',{% endfor %}];
        const promedios = [{% for curso in notas_por_curso %}{{ curso.promedio_final|default:0 }},{% endfor %}];
        
        new Chart(ctxRendimiento, {
            type: 'bar',
            data: {
                labels: cursos,
                datasets: [{
                    label: 'Promedio por Curso',
                    data: promedios,
                    backgroundColor: promedios.map(p => {
                        if (p >= 13) return '#28a745';
                        if (p >= 10.5) return '#17a2b8';
                        if (p > 0) return '#ffc107';
                        return '#6c757d';
                    }),
                    borderColor: promedios.map(p => {
                        if (p >= 13) return '#218838';
                        if (p >= 10.5) return '#138496';
                        if (p > 0) return '#e0a800';
                        return '#545b62';
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 20,
                        title: {
                            display: true,
                            text: 'Nota Final'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const cursoIndex = context.dataIndex;
                                const curso = {{ notas_por_curso|length }} > cursoIndex ? 
                                    '{{ notas_por_curso.0.nombre_curso|escapejs }}' : 'Curso';
                                return `${curso}: ${context.parsed.y}`;
                            }
                        }
                    }
                }
            }
        });

        // Animación para las tarjetas de estadísticas
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card-estadistica');
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.1}s`;
                card.classList.add('animate__animated', 'animate__fadeInUp');
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>